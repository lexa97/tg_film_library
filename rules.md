## Project Rules (Обязательные правила проекта)

**Проект:** Telegram-бот «Кинобиблиотека группы». Спецификация — **task.md**.

---

### 1. Общая архитектура

- Проект строится по принципу **разделения ответственности (SRP)**.
- Хендлеры Telegram, бизнес-логика, работа с БД и интеграции (TMDB) **строго разделены**.
- Хендлеры aiogram используются **только как слой приёма обновлений**, без бизнес-логики внутри.

Структура проекта:
```
app/
  handlers/       # Обработчики сообщений и callback'ов Telegram (aiogram)
  keyboards/      # Inline- и reply-клавиатуры
  db/             # SQLAlchemy, модели БД, репозитории
  middlewares/    # Middlewares (например, сессия БД)
  services/       # Бизнес-логика и работа с TMDB
  states/         # FSM-состояния (создание группы и др.)
  utils/          # Вспомогательные функции
```
Все запуски кода делаем из локального окружения, находится оно в папке .\venv\, код для активации из под windows .\.venv\Scripts\Activate.ps1 


---

### 2. Код только на классах

- **Вся бизнес-логика реализуется через классы**.
- Функции допустимы **только**:
  - как приватные утилиты внутри классов
  - в `utils/` для технических задач (форматирование, парсинг)
  - регистрация хендлеров и роутеров

Примеры сервисов:
- `UserGroupService` — пользователи, группы, добавление по контакту
- `FilmService` / `TMDBFilmSearch` — поиск фильмов, работа с TMDB
- `GroupFilmService` — список «к просмотру», отметка «просмотрен»

---

### 3. Наследование и базовые классы

- Использовать **базовые/абстрактные классы**, где есть общая логика.

Примеры:
- `BaseFilmSearchProvider` (ABC) → `TMDBFilmSearch`
- `BaseRepository`
- При расширении: второй провайдер поиска (например, OMDb) — новый класс, без смены сценариев бота

Запрещено:
- Копипаст логики между сервисами
- Длинные цепочки if/else по типу сущности — предпочтительнее полиморфизм

---

### 4. Бизнес-логика

- Вся логика принятия решений (добавить в группу, можно ли отметить просмотренным, поиск и маппинг фильмов):
  - находится **в сервисах**
  - оформлена **в отдельные методы**
  - вся работа с БД происходит в этом слое

Примеры методов:
- `add_member_by_contact()` / `add_member_by_contact_for_current_admin()`
- `search_films()` / `get_film_details()`
- `add_film_to_group()`, `mark_watched()`
- `get_group_films()`, `get_group_for_user()`

Слой хендлеров **не думает**, он только извлекает данные из сообщения и вызывает методы сервисов.

---

### 5. Слой хендлеров (Telegram)

- Хендлеры — приём обновлений (message, callback) + вызов сервисов + формирование ответа (сообщение + клавиатура).
- В хендлерах запрещено:
  - работать напрямую с БД
  - принимать бизнес-решения (добавлять ли в группу, можно ли отметить просмотренным)
  - парсить ответы TMDB (только в services)

Хендлер отвечает за:
- извлечение данных из `message` / `callback` (текст, contact, callback_data)
- валидацию/нормализацию входных данных (при необходимости — Pydantic)
- вызов метода сервиса
- формирование ответа через `keyboards/`

---

### 6. Pydantic

- **Все структурированные входные и выходные данные — Pydantic-модели**
- Отдельные модели для:
  - обмена между слоями (сервис ↔ хендлер)
  - DTO из TMDB
  - конфигурации (pydantic-settings)

Запрещено:
- передавать `dict` между слоями

---

### 7. Работа с БД

- Доступ к БД **только через репозитории** (или сервисы доступа к данным в `db/`)
- Один репозиторий — одна сущность (users, groups, group_members, films, group_films, watched)
- Репозитории не содержат бизнес-логики (только CRUD)
- Инициализация БД — простой скрипт `initdb.py` (SQLAlchemy create_all), схема по п. 7 task.md

---

### 8. Сервисы и TMDB

- Вся работа с TMDB (поиск, детали, переводы/альтернативные названия) — в `services/` (например, `tmdb.py`, `film.py`).
- Абстракция «поисковик» (интерфейс) + реализация под TMDB; при расширении — вторая реализация без смены сценариев бота.
- Логика анализа и маппинга ответов TMDB — **вне хендлеров**, только в сервисах.
- Соблюдать лимиты запросов TMDB, при необходимости кэшировать.

---

### 9. Пользователи и группы

- **Группа** — логическая сущность в боте (название + участники), не чат Telegram. Взаимодействие с ботом — в **личном чате**.
- Добавление в группу: пользователь сначала `/start`, затем админ отправляет контакт. Использовать `message.contact.user_id` (aiogram).
- MVP: один пользователь — одна группа (выбор группы в сценариях не показываем).
- Роли: admin (создатель группы), member. Проверка прав — в сервисах.

---

### 10. Расширяемость

- Добавление нового источника фильмов (например, OMDb) =
  - новый класс-провайдер, реализующий интерфейс поиска
  - без переписывания существующих сценариев бота
- Расширение ролей и конфигов — через конфигурацию и сервисы, не через раздувание хендлеров

---

### 11. Принципы

- **Явно лучше, чем магия** — без лишнего метапрограммирования.
- **Простота важнее универсальности** — MVP: одна группа на пользователя, один источник фильмов (TMDB).
- **Если код "умный", значит он плохой** — предпочтительнее читаемость.
- **Безопасность:** авторизация через Telegram (пароли не используются); лимиты и при необходимости кэш при работе с TMDB.

---

### 12. Итог

- **Хендлеры** — только приём обновлений и вызов сервисов.
- **Сервисы** — вся бизнес-логика, работа с репозиториями и TMDB.
- **Репозитории** — только работа с БД.

Спецификация: **task.md**. Правила для AI/редактора: **.cursorrules**.
