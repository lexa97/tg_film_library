# Техническое задание: Telegram-бот «Кинобиблиотека группы»

## 1. Цель проекта

Сервис в виде Telegram-бота для совместного учёта фильмов и сериалов в группах пользователей: создание групп, поиск по открытым базам фильмов, общий список «к просмотру» и отметки «просмотрено».

Основные правила проекта: rules.md

---

## 2. Концепция и сценарии

### 2.1. Модель «группы»

**Важно:** под «группой» понимается **логическая группа внутри бота** (название + список участников), а не чат Telegram. Взаимодействие с ботом — в **личном чате** (private chat). Участники группы — пользователи, добавленные админом по контакту.

### 2.2. Уведомления

Участникам группы не нужно общаться друг с другом в общем чате. Достаточно уведомлений:
- когда кто-то добавил фильм в список группы;
- когда фильм отмечен как просмотренный.

### 2.3. Сценарии

| № | Роль | Действие | Поведение бота |
|---|------|----------|----------------|
| 1 | Админ | Создаёт группу с произвольным названием | Бот запоминает группу и назначает создателя админом группы |
| 2 | Новый пользователь (не в группе) | Нажимает /start | Сообщение: «Вас ещё нет ни в одной группе. Сначала нажмите /start у бота, затем попросите админа добавить вас, отправив ему ваш контакт для пересылки боту» |
| 3 | Админ | Отправляет боту контакт пользователя (share contact) | Бот извлекает `user_id` из контакта (см. п. 6.2) и добавляет пользователя в группу; уведомляет нового участника и админа |
| 4 | Участник группы | Отправляет название фильма/сериала (текстом) | Поиск в API (учёт разных языков названий, см. п. 6.3); при одном результате — карточка + кнопка «Подтвердить»; при нескольких — несколько карточек с кнопками |
| 5 | Пользователь | Нажимает «Подтвердить» у выбранного варианта | Фильм добавляется в список группы; уведомление всем участникам группы |
| 6 | Участник | Запрашивает список (целиком или поиск по названию) | Бот выводит список фильмов группы с поиском по названию или вывод всего списка |
| 7 | Участник | Отмечает фильм как просмотренный | Общая галочка на группу; в списке фильм помечается «просмотрен»; уведомление участникам группы |

---

## 3. Принятые решения (договорённости)

1. **Отметка «просмотрен»** — одна общая галочка на группу («мы посмотрели»). Кто-то один нажимает «просмотрен», для всей группы фильм считается просмотренным.

2. **Несколько групп** — на старте пользователь в одной роли, только в одной группе. Выбор группы в сценариях не показываем.

3. **База фильмов** — фильмы могут быть и российские, и зарубежные; названия — на английском, языке оригинала или на русском. Нужно учитывать переводы и то, что на разных языках фильмы называются по-разному. Используем TMDB (поддержка мультиязычности, альтернативные названия, переводы; см. п. 8).

4. **Сериалы** — достаточно добавлять сериал целиком, без детализации по сезонам/сериям.

5. **Удаление фильмов** — не требуется.

---

## 4. Вариант разработки (MVP)

- Один источник фильмов — TMDB (мультиязычность, альтернативные названия, переводы).
- Один пользователь — одна группа (участник или админ); без выбора группы в сценариях.
- Отметка «просмотрен» — общая на группу.
- Уведомления: при добавлении фильма и при отметке «просмотрен» — всем участникам группы.
- Команды: создание группы, добавление по контакту (contact.user_id), поиск фильма, подтверждение, список/поиск по списку, «отметить просмотренным».
- Удаление фильмов не требуется.


---

## 5. Стек и окружение

| Компонент | Технология |
|-----------|------------|
| Язык | Python 3.11+ |
| Фреймворк бота | aiogram 3.7.x |
| БД | PostgreSQL 14+ |
| Миграции | Alembic |
| Конфигурация | pydantic-settings, .env |
| Поиск фильмов | TMDB API (мультиязычность, переводы, альтернативные названия) |

---

## 6. Функциональные требования (для разработки)

### 6.1. Пользователи и группы

- Хранение пользователей: `user_id` (Telegram), `username`, `first_name`, `last_name`, дата первого контакта.
- Группы: название, `created_at`, связь с админом (user_id создателя).
- Участники групп: связь user_id ↔ group_id, роль (admin / member). У одной группы один админ (создатель);

### 6.2. Добавление в группу

- Пользователь должен **сначала** подключиться к боту (нажать /start), затем админ добавляет его через отправку контакта.
- Админ отправляет боту контакт (тип `contact` в Telegram; «Поделиться контактом» из профиля пользователя).
- В Bot API объект **Contact** содержит опциональное поле **user_id** (Telegram User ID того, чей контакт передан). Оно присутствует, когда передан контакт пользователя Telegram (например, через «Поделиться контактом»). В aiogram: `message.contact.user_id` — использовать его, если задан.
- Если `user_id` в контакте отсутствует (например, передан контакт только из телефонной книги без привязки к Telegram), остаётся только `phone_number`; добавление по номеру возможно только при наличии этого номера в нашей БД (например, если пользователь ранее где-то его указал). На старте достаточно сценария: пользователь нажал /start → админ пересылает его контакт из Telegram → бот получает `contact.user_id`.
- После добавления — уведомить нового участника и админа.

### 6.3. Поиск фильма

- Триггер: текстовое сообщение в личку боту от пользователя, состоящего хотя бы в одной группе.

- Названия фильмов могут быть на разных языках (русский, английский, язык оригинала). Нужно учитывать переводы и альтернативные названия.
- **TMDB:** поиск учитывает оригинальные, переведённые и альтернативные названия. Использовать Search Multi или Search Movie/TV с параметром языка; при необходимости запрашивать переводы/альтернативные названия по `movie/{id}/translations` и `movie/{id}/alternative_titles` для вывода пользователю. Сохранять в БД основное название и при желании вариант на русском (если есть).
- Результаты: до N вариантов (например, 5). Для каждого: название (предпочтительно на языке запроса или русском, если есть), год, описание (короткое), постер (если есть).
- Один результат: сообщение с карточкой + одна inline-кнопка «Подтвердить».
- Несколько: список карточек, у каждой — своя inline-кнопка «Подтвердить» (callback с `film_id`/external_id и при необходимости source).

### 6.4. Подтверждение и список «к просмотру»

- По нажатию «Подтвердить»: сохранить в БД фильм (внешний id, название, год, описание, постер, источник) и привязку к группе (group_id).
- Уведомить всех участников группы о добавлении фильма.

### 6.5. Вывод списка группы (как работает)

- **Команда:** `/list` или кнопка «Мой список» (в меню после /start) — выводит общий список фильмов группы.
- **Вид списка:** список из названий фильмов в виде **inline-кнопок** (каждая кнопка — название одного фильма). Просмотренные можно помечать визуально (например, префикс «✓ » перед названием или отдельный ряд кнопок «Просмотренные»). При большом количестве — пагинация (например, «Далее» / «Назад») или разбивка по сообщениям.
- **По нажатию на кнопку (название фильма):** бот отправляет сообщение с описанием фильма (название, год, описание; постер по возможности), а **под сообщением** — одна inline-кнопка **«Просмотрено»**.
- **Поиск по списку:** опционально — перед выводом кнопок запрос «Введите часть названия или нажмите «Весь список»»; либо отдельная команда/кнопка «Поиск в списке» с вводом строки и выводом отфильтрованных названий теми же inline-кнопками.

### 6.6. Отметка «просмотрен»

- Кнопка «Просмотрено» под сообщением с описанием фильма (см. п. 6.5): по нажатию фильм помечается просмотренным для всей группы.
- В списке (inline-кнопки) просмотренные отображаются с пометкой (например, «✓ Название»).
- При отметке фильма просмотренным — уведомить участников группы.

### 6.7. Команды и меню

- `/start` — приветствие; если пользователь не в группах — текст: «Сначала нажмите /start у бота, затем попросите админа добавить вас, отправив ему ваш контакт для пересылки боту»; иначе — краткое меню (создать группу / мой список и т.д.).
- `/list` — вывод списка группы (названия фильмов как inline-кнопки; по нажатию — описание + кнопка «Просмотрено»).
- Создание группы: отдельный поток (FSM): запрос названия → создание группы, сообщение об успехе.
- Добавление участника: админ отправляет контакт боту (пользователь в одной группе — выбор группы не показываем).

---

## 7. Структура БД (черновик)

- **users** — id (PK), telegram_user_id (unique), username, first_name, last_name, phone, created_at.
- **groups** — id (PK), name, admin_user_id (FK → users), created_at.
- **group_members** — id (PK), group_id (FK), user_id (FK), role (admin/member), joined_at.
- **films** — id (PK), external_id, source (tmdb/omdb), title (основное для отображения, например русское или оригинал), title_original, year, description, poster_url, created_at.
- **group_films** — id (PK), group_id (FK), film_id (FK), added_by_user_id (FK), created_at.  
  (Один и тот же film может быть в нескольких группах через разные записи group_films.)
- **watched** (общая отметка на группу): group_film_id (PK или unique FK), watched_at, [optional: user_id кто отметил]. Одна запись на group_film — фильм просмотрен всей группой.

Индексы: по `telegram_user_id`, `group_id`, `group_films(group_id)`, по полям поиска (title, год).

---

## 8. API фильмов (кратко)

- **TMDB:** бесплатный ключ, мультиязычность, поиск фильмов и сериалов. Поиск учитывает оригинальные, переведённые и альтернативные названия. Отдельные эндпоинты: переводы (`movie/{id}/translations`), альтернативные названия (`movie/{id}/alternative_titles`). Параметр `language` в поиске (например, `ru`, `en`). Документация: https://www.themoviedb.org/documentation/api .
---

## 9. Этапы разработки (предложение)

1. **Среда и каркас:** репозиторий, venv, зависимости (aiogram, asyncpg или SQLAlchemy 2, alembic, pydantic-settings), .env, структура папок (handlers, services, models, db).
2. **БД:** модели и миграции Alembic, таблицы по п. 7.
3. **Пользователи и группы:** /start, регистрация пользователя, FSM создание группы, добавление по контакту (contact.user_id в aiogram).
4. **Поиск и подтверждение:** интеграция с TMDB (поиск с учётом языков/переводов), обработка текста как запроса, вывод результатов и callback «Подтвердить», сохранение в group_films, уведомление участникам группы.
5. **Список и просмотренное:** вывод списка группы, поиск по названию, отметка «просмотрен» (общая на группу), уведомление участникам.
6. **Полировка:** обработка ошибок, логирование.

---

## 10. Риски и ограничения

- **Контакты Telegram:** в объекте Contact поле `user_id` опционально. Оно присутствует, когда админ пересылает контакт пользователя Telegram (например, через «Поделиться контактом»). Пользователь должен заранее нажать /start у бота. Если передан только номер из телефонной книги без привязки к Telegram, `user_id` не будет — на старте этот сценарий не поддерживаем.
- **Лимиты API:** TMDB — в MVP rate limiting не учитываем.

---

## 11. Технические решения (утверждено)

### 11.1. Уведомления

- **Реализация:** обёртка `bot.send_message` в отдельный сервис `NotificationService`.
- **Формат:**
  - При добавлении фильма: название фильма + inline-кнопка для получения описания.
  - В остальных случаях (отметка просмотренным): простой текст.
- **Обработка ошибок:** если пользователь заблокировал бота, сообщать об этом факте админу группы.

### 11.2. Конфигурация (.env)

Параметры загружаются сначала из `.env` файла, если не найден — из переменных окружения:
- `BOT_TOKEN` — токен Telegram-бота
- `TMDB_API_KEY` — API ключ TMDB (Bearer token)
- `DATABASE_URL` — URL подключения к PostgreSQL (формат: `postgresql+asyncpg://user:password@host:port/dbname`)

### 11.3. Пагинация

- На одной странице списка фильмов: **10 фильмов**.
- Навигация через inline-кнопки «Далее» / «Назад».

### 11.4. Логирование

- Стандартный модуль `logging`, вывод в консоль.
- Уровень: INFO для основных действий, ERROR для ошибок.

### 11.5. Развёртывание

- Docker Compose с двумя сервисами: PostgreSQL и бот.
- `docker-compose.yml` включает конфигурацию БД и автоматические миграции при старте.

### 11.6. Тестирование

**Базовые тесты (pytest + pytest-asyncio):**
1. Создание группы.
2. Добавление пользователя в группу.
3. Поиск фильма (мок TMDB API).
4. Добавление фильма в список группы.
5. Отметка фильма просмотренным.

**Автоматические проверки:**
- Запуск кода без ошибок (import checks).
- Линтер (ruff или flake8).
- Проверка соответствия версиям библиотек.

---

## 12. Результат

- Рабочий бот в личке: создание групп, добавление по контакту, поиск фильма → подтверждение → общий список группы с отметкой «просмотрен».
- Код на Python (aiogram 3, async), PostgreSQL, Docker Compose.
- Базовые тесты и проверки качества кода.
- Описание запуска в README.
